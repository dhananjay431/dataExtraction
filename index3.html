<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-4.0.0.slim.min.js"></script>
    <script src="./dist/bundle.js"></script>
    <script src="./src/lib/build/leader-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>



    <style>
        #start,
        #end {
            width: 50px;
            height: 20px;
            background-color: red;
        }

        #dbPdf,
        #the-canvas {
            position: relative;
        }


        #db_curr {
            position: absolute;

            /* width: 5px;
            height: 5px;
            background-color: blue; */
        }
    </style>
</head>

<body>

    <div id="start">start</div>
    <div id="end">end</div>
    <div class="row">


        <div class="col-6">
            <input type="file" id="file">
        </div>
        <div class="col-6" id="cord">

        </div>

        <div class="col-8" id="dbPdf">

            <canvas id="the-canvas" class="img-fluid">

            </canvas>
            <div id="db_curr"></div>

        </div>
        <div class="col-4" id="list">


        </div>
    </div>
    <script>

        function shape(ctx, s, ...end) {
            ctx.beginPath();
            ctx.moveTo(s.x, s.y);
            for (let i = 0; i < end.length; i++) {
                ctx.lineTo(end[i].x, end[i].y);
            }
            ctx.lineTo(s.x, s.y);
            ctx.fillStyle = "rgba(0, 150, 255, 0.3)";
            ctx.fill();

            // ✏️ border
            ctx.strokeStyle = "blue";
            ctx.stroke()
        }
        var line;
        var page = {};
        line = new LeaderLine(
            document.getElementById('start'),
            document.getElementById('end')
        );

        var arr = [];
        dbPDF.ev(document.getElementById("the-canvas"), 'click').subscribe((r) => {
            arr.push({ x: r.offsetX, y: r.offsetY });
            console.log(arr);
        })
        setTimeout(() => {

            dbPDF.ev(document.getElementById("list"), "mousemove").subscribe(r => {
                console.log("move=>", r.srcElement.id);


                let f = arrList.products.find(d => d.id == r.srcElement.id)
                console.log(f.cord);
                let db_curr = document.getElementById("db_curr");
                db_curr.style.position = "absolute";
                db_curr.style.left = f.cord[2].x + "px";
                db_curr.style.top = f.cord[2].y + "px";
                // db_curr.style.width = f.cord[2].x + "px";
                // db_curr.style.height = f.cord[3] + "px";


                line.start = document.getElementById(f.id);
                line.end = db_curr;
                line.position();
                line.show();
            })
            // dbPDF.ev(document.getElementsByClassName("action"), "click").subscribe(r => {



            // })
        }, 2000)

        dbPDF.pp(
            dbPDF.ev(document.getElementById("file"), 'change'),
            dbPDF.mm(d => dbPDF.f(dbPDF.pdf({ pdfData: d.target.files[0], pageNumber: 1, scale: 1, id: "the-canvas" }))),
            dbPDF.t(d => {
                let canvas = document.getElementById('the-canvas');
                let context = canvas.getContext('2d');
                shape(context, { x: 20, y: 20 }, { x: 100, y: 20 }, { x: 175, y: 100 }, { x: 20, y: 100 });
                // for (let i = 0; i < arrList.products.length; i++) {
                //     context.lineWidth = 1;
                //     context.fillStyle = '#e61b8412';
                //     context.rect(...arrList.products[i].cord);
                //     context.fill();
                // }

                // for (let i = 0; i < arrList.products.length; i++) {
                //     debugger
                //     shape(context, arrList.products[i].cord[0], arrList.products[i].cord[1], arrList.products[i].cord[2], arrList.products[i].cord[3]);
                // }
            }),
            // dbPDF.mm(x => dbPDF.ev(document.getElementById("the-canvas"), "mousemove"))
        )

            .subscribe(ev => {
                // 
                line.hide();
                let canvas = document.getElementById('the-canvas');
                let context = canvas.getContext('2d')
                let svg = createSvg(canvas.width, canvas.height);

                for (let i = 0; i < arrList.products.length; i++) {

                    let polygon = createPolygon(arrList.products[i].cord.map(d => d.x + "," + d.y).join(" "), "rgba(0,150,255,0.3)", "blue");

                    polygon.addEventListener("mouseenter", (ev) => {
                        console.log(arrList.products[i].id);


                        let db_curr = document.getElementById("db_curr");
                        db_curr.style.position = "absolute";
                        db_curr.style.left = ev.offsetX + "px";
                        db_curr.style.top = ev.offsetY + "px";
                        line.end = document.getElementById(arrList.products[i].id);
                        line.start = db_curr;

                        line.position();
                        line.show();
                    });
                    svg.appendChild(polygon);
                }
                svg.style.position = "absolute";
                svg.style.top = "0px";
                svg.style.left = "0px";
                document.getElementById("dbPdf").appendChild(svg);

                // 
            })
        var arrList = {};
        function getData() {

            var cc = [
                [
                    {
                        "x": 474,
                        "y": 8
                    },
                    {
                        "x": 599,
                        "y": 6
                    },
                    {
                        "x": 620,
                        "y": 85
                    },
                    {
                        "x": 467,
                        "y": 93
                    }
                ],
                [
                    {
                        "x": 176,
                        "y": 110
                    },
                    {
                        "x": 893,
                        "y": 108
                    },
                    {
                        "x": 882,
                        "y": 181
                    },
                    {
                        "x": 191,
                        "y": 192
                    }
                ],
                [
                    {
                        "x": 188,
                        "y": 216
                    },
                    {
                        "x": 268,
                        "y": 205
                    },
                    {
                        "x": 267,
                        "y": 280
                    },
                    {
                        "x": 181,
                        "y": 288
                    }
                ],
                [
                    {
                        "x": 294,
                        "y": 218
                    },
                    {
                        "x": 399,
                        "y": 206
                    },
                    {
                        "x": 387,
                        "y": 260
                    },
                    {
                        "x": 301,
                        "y": 267
                    }
                ],
                [
                    {
                        "x": 431,
                        "y": 213
                    },
                    {
                        "x": 518,
                        "y": 208
                    },
                    {
                        "x": 522,
                        "y": 287
                    },
                    {
                        "x": 427,
                        "y": 270
                    }
                ],
                [
                    {
                        "x": 574,
                        "y": 211
                    },
                    {
                        "x": 646,
                        "y": 201
                    },
                    {
                        "x": 655,
                        "y": 259
                    },
                    {
                        "x": 564,
                        "y": 267
                    }
                ],
                [
                    {
                        "x": 688,
                        "y": 204
                    },
                    {
                        "x": 746,
                        "y": 201
                    },
                    {
                        "x": 792,
                        "y": 257
                    },
                    {
                        "x": 693,
                        "y": 264
                    }
                ],
                [
                    {
                        "x": 799,
                        "y": 204
                    },
                    {
                        "x": 860,
                        "y": 195
                    },
                    {
                        "x": 877,
                        "y": 278
                    },
                    {
                        "x": 792,
                        "y": 270
                    }
                ],
                [
                    {
                        "x": 14,
                        "y": 340
                    },
                    {
                        "x": 1053,
                        "y": 336
                    },
                    {
                        "x": 1047,
                        "y": 417
                    },
                    {
                        "x": 39,
                        "y": 433
                    }
                ],
                [
                    {
                        "x": 450,
                        "y": 476
                    },
                    {
                        "x": 1032,
                        "y": 476
                    },
                    {
                        "x": 1034,
                        "y": 604
                    },
                    {
                        "x": 475,
                        "y": 620
                    }
                ],
                [
                    {
                        "x": 24,
                        "y": 664
                    },
                    {
                        "x": 168,
                        "y": 658
                    },
                    {
                        "x": 169,
                        "y": 709
                    },
                    {
                        "x": 41,
                        "y": 718
                    }
                ],
                [
                    {
                        "x": 37,
                        "y": 731
                    },
                    {
                        "x": 1036,
                        "y": 730
                    },
                    {
                        "x": 1037,
                        "y": 1159
                    },
                    {
                        "x": 43,
                        "y": 1162
                    }
                ],
                [
                    {
                        "x": 33,
                        "y": 1193
                    },
                    {
                        "x": 150,
                        "y": 1187
                    },
                    {
                        "x": 160,
                        "y": 1235
                    },
                    {
                        "x": 44,
                        "y": 1249
                    }
                ],
                [
                    {
                        "x": 46,
                        "y": 1262
                    },
                    {
                        "x": 1024,
                        "y": 1260
                    },
                    {
                        "x": 1044,
                        "y": 1695
                    },
                    {
                        "x": 33,
                        "y": 1688
                    }
                ],
                [
                    {
                        "x": 27,
                        "y": 1736
                    },
                    {
                        "x": 198,
                        "y": 1728
                    },
                    {
                        "x": 173,
                        "y": 1771
                    },
                    {
                        "x": 20,
                        "y": 1781
                    }
                ],
                [
                    {
                        "x": 37,
                        "y": 1796
                    },
                    {
                        "x": 1034,
                        "y": 1790
                    },
                    {
                        "x": 1041,
                        "y": 2224
                    },
                    {
                        "x": 42,
                        "y": 2229
                    }
                ],
                [
                    {
                        "x": 36,
                        "y": 2268
                    },
                    {
                        "x": 170,
                        "y": 2261
                    },
                    {
                        "x": 177,
                        "y": 2310
                    },
                    {
                        "x": 30,
                        "y": 2316
                    }
                ],
                [
                    {
                        "x": 43,
                        "y": 2336
                    },
                    {
                        "x": 1041,
                        "y": 2334
                    },
                    {
                        "x": 1040,
                        "y": 2750
                    },
                    {
                        "x": 46,
                        "y": 2756
                    }
                ],
                [
                    {
                        "x": 51,
                        "y": 830
                    },
                    {
                        "x": 276,
                        "y": 829
                    },
                    {
                        "x": 283,
                        "y": 851
                    },
                    {
                        "x": 48,
                        "y": 860
                    }
                ],
                [
                    {
                        "x": 50,
                        "y": 885
                    },
                    {
                        "x": 342,
                        "y": 882
                    },
                    {
                        "x": 334,
                        "y": 906
                    },
                    {
                        "x": 49,
                        "y": 912
                    }
                ],
                [
                    {
                        "x": 54,
                        "y": 940
                    },
                    {
                        "x": 296,
                        "y": 928
                    },
                    {
                        "x": 289,
                        "y": 959
                    },
                    {
                        "x": 57,
                        "y": 963
                    }
                ],
                [
                    {
                        "x": 59,
                        "y": 987
                    },
                    {
                        "x": 181,
                        "y": 980
                    },
                    {
                        "x": 171,
                        "y": 1010
                    },
                    {
                        "x": 62,
                        "y": 1012
                    }
                ],
                [
                    {
                        "x": 59,
                        "y": 1036
                    },
                    {
                        "x": 216,
                        "y": 1036
                    },
                    {
                        "x": 216,
                        "y": 1060
                    },
                    {
                        "x": 56,
                        "y": 1054
                    }
                ],
                [
                    {
                        "x": 52,
                        "y": 1081
                    },
                    {
                        "x": 218,
                        "y": 1080
                    },
                    {
                        "x": 223,
                        "y": 1109
                    },
                    {
                        "x": 57,
                        "y": 1117
                    }
                ],
                [
                    {
                        "x": 54,
                        "y": 1362
                    },
                    {
                        "x": 160,
                        "y": 1370
                    },
                    {
                        "x": 149,
                        "y": 1402
                    },
                    {
                        "x": 60,
                        "y": 1397
                    }
                ],
                [
                    {
                        "x": 57,
                        "y": 1422
                    },
                    {
                        "x": 166,
                        "y": 1415
                    },
                    {
                        "x": 168,
                        "y": 1447
                    },
                    {
                        "x": 60,
                        "y": 1448
                    }
                ],
                [
                    {
                        "x": 57,
                        "y": 1473
                    },
                    {
                        "x": 218,
                        "y": 1467
                    },
                    {
                        "x": 222,
                        "y": 1492
                    },
                    {
                        "x": 57,
                        "y": 1502
                    }
                ],
                [
                    {
                        "x": 49,
                        "y": 1514
                    },
                    {
                        "x": 285,
                        "y": 1517
                    },
                    {
                        "x": 287,
                        "y": 1539
                    },
                    {
                        "x": 58,
                        "y": 1544
                    }
                ],
                [
                    {
                        "x": 57,
                        "y": 1563
                    },
                    {
                        "x": 137,
                        "y": 1566
                    },
                    {
                        "x": 137,
                        "y": 1590
                    },
                    {
                        "x": 59,
                        "y": 1592
                    }
                ],
                [
                    {
                        "x": 58,
                        "y": 1616
                    },
                    {
                        "x": 370,
                        "y": 1612
                    },
                    {
                        "x": 383,
                        "y": 1638
                    },
                    {
                        "x": 66,
                        "y": 1647
                    }
                ]
            ];

            fetch("https://dummyjson.com/products").then(r => r.json()).then(r => {
                arrList = r;
                // 
                for (let i = 0; i < arrList.products.length; i++) {
                    // arrList.products[i].cord = [i, (15 * i), 10, 10];
                    arrList.products[i].cord = cc[i];
                }
                let list = document.getElementById("list")
                let ul = document.createElement("ul");
                ul.style.top = "0";
                ul.style.position = "sticky";
                ul.innerHTML = r.products.map(d => {
                    return `<li id="${d.id}" class="action w-100">${d.title}</li>`;
                }).join("")
                list.appendChild(ul);

            })
        }
        getData();

        function createSvg(w, h) {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", w);
            svg.setAttribute("height", h);
            svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
            //   svg.style.border = "1px solid black";
            return svg
        }

        function createPolygon(points, fill, stroke) {
            const svgNS = "http://www.w3.org/2000/svg";
            const polygon = document.createElementNS(svgNS, "polygon");
            polygon.setAttribute("points", points);
            polygon.setAttribute("fill", fill);
            // polygon.setAttribute("fill", "rgba(0,150,255,0.3)");
            polygon.setAttribute("stroke", stroke);
            return polygon
        }



        // svg.appendChild(polygon);
        // document.body.appendChild(svg);
        // add to page


    </script>
</body>

</html>